# we utilize the images generated by the build-images project, to
# speed up CI runs. We also use ccache and store config.cache
# to speed up compilation. We include a version number in cache
# name to allow expiration of old caches.

cache:
  key: "$CI_JOB_NAME-ver1"
  paths:
    - cache/

before_script:
  # CCache Config
  - mkdir -p cache
  - export CCACHE_BASEDIR=${PWD}
  - export CCACHE_DIR=${PWD}/cache
  - export CC="ccache gcc"

after_script:
  # somehow after_script looses environment
  - export CCACHE_BASEDIR=${PWD}
  - export CCACHE_DIR=${PWD}/cache
  - ccache -s

variables:
  BUILD_IMAGES_PROJECT: gnuwget/build-images
  DEBIAN_BUILD: buildenv-debian-stretch
  FEDORA_BUILD: buildenv-f27
  CENTOS7_BUILD: buildenv-centos7
  MINGW_BUILD: buildenv-mingw
  GET_SOURCES_ATTEMPTS: "3"
  CONFIGURE_BASE_FLAGS: --enable-assert --cache-file cache/config.cache
  CFLAGS_DEFAULT: -O0 -g -ggdb3


# We organize the CI runners as thus:
#   1. Debian Stretch Build:
#       * ASan and UBSan builds
#       * make syntax-check
#       * make distcheck
#
#   2. Fedora 27 Build
#       * LLVM/Clang Build
#       * Valgrind Tests
#
#   3. CentOS7 Build
#       * Build with musl / newlib
#       * Minimal Build (All features disabled)
#
#   This way we split most of the different build options across different
#   platforms as well. Other builds we would like to have:
#
#   1. Windows
#   2. OSX
#   3. Documentation Generation and Gitlab pages
#   4. Code coverage stats

# In this build we combine
#  * gcc
#  * check, syntax-check, distcheck
Full/Debian:
  image: $CI_REGISTRY/$BUILD_IMAGES_PROJECT:$DEBIAN_BUILD
  script:
    - export CFLAGS=$CFLAGS_DEFAULT
    - ./bootstrap && touch .manywarnings
    - ./configure $CONFIGURE_BASE_FLAGS
    - make -j$(nproc) check
    - make -j$(nproc) distcheck
  tags:
    - shared
  artifacts:
    expire_in: 2 weeks
    when: on_failure
    paths:
      - ./*.log
      - fuzz/*.log
      - unit-tests/*.log
      - tests/*.log

# In this build we combine
#  * gcc
#  * check, syntax-check, distcheck
Minimal/Debian:
  image: $CI_REGISTRY/$BUILD_IMAGES_PROJECT:$DEBIAN_BUILD
  script:
    - export CFLAGS=$CFLAGS_DEFAULT
    - ./bootstrap && touch .manywarnings
    - ./configure $CONFIGURE_BASE_FLAGS --disable-doc \
        --disable-xattr --without-gnutls --without-libpsl --without-libnghttp2 --without-bzip2 \
        --without-gpgme --without-zlib --without-lzma --without-brotlidec --without-libidn2 \
        --without-libidn --without-libpcre2 --without-libpcre --without-plugin-support
    - make -j$(nproc) check
    - make -j$(nproc) distcheck
  tags:
    - shared
  artifacts:
    expire_in: 2 weeks
    when: on_failure
    paths:
      - ./*.log
      - fuzz/*.log
      - unit-tests/*.log
      - tests/*.log

# In this build we combine
#  * clang
#  * ASan, UBSan
#  * check, syntax-check, distcheck
Sanitizers/Debian:
  image: $CI_REGISTRY/$BUILD_IMAGES_PROJECT:$DEBIAN_BUILD
  script:
    - export CFLAGS=$CFLAGS_DEFAULT
    - ./bootstrap && touch .manywarnings
    - export CC="ccache clang"
    - export UBSAN_OPTIONS=print_stacktrace=1
    - export ASAN_SYMBOLIZER_PATH=/usr/lib/llvm-3.8/bin/llvm-symbolizer
    - export LSAN_OPTIONS=suppressions="$PWD/tests/clang-asan-suppressions"
    - ./configure $CONFIGURE_BASE_FLAGS --enable-fsanitize-asan --enable-fsanitize-ubsan
    - make -j$(nproc) check
    - make -j$(nproc) distcheck
  tags:
    - shared
  artifacts:
    expire_in: 2 weeks
    when: on_failure
    paths:
      - ./*.log
      - fuzz/*.log
      - unit-tests/*.log
      - tests/*.log

Scan-Build/Debian:
  image: $CI_REGISTRY/$BUILD_IMAGES_PROJECT:$DEBIAN_BUILD
  script:
    - export CFLAGS=$CFLAGS_DEFAULT
    - ./bootstrap && touch .manywarnings
    - scan-build ./configure $CONFIGURE_BASE_FLAGS --disable-manywarnings
    - make -C lib -j$(nproc)
    - scan-build -v -enable-checker security,nullability --status-bugs -o scan-build make -j$(nproc)
    - scan-build -v -enable-checker security,nullability --status-bugs -o scan-build make -j$(nproc) check
  tags:
    - shared
  except:
    - tags
  artifacts:
    expire_in: 2 weeks
    when: on_failure
    paths:
      - scan-build/*

Flawfinder/Debian:
  image: $CI_REGISTRY/$BUILD_IMAGES_PROJECT:$DEBIAN_BUILD
  script:
    - export CFLAGS=$CFLAGS_DEFAULT
    - ./bootstrap
    - ./configure $CONFIGURE_BASE_FLAGS --disable-manywarnings
    - make -j$(nproc)
    - mkdir flawfinder
    - flawfinder -CcQH src/ libwget/ tests/ fuzz/ unit-tests/ > flawfinder/flawfinder.html
    - flawfinder -ICcQH src/ libwget/ tests/ fuzz/ unit-tests/ > flawfinder/flawfinder-inputs.html
  tags:
    - shared
  except:
    - tags
  artifacts:
    expire_in: 2 weeks
    when: always
    paths:
      - flawfinder/*

Valgrind/Fedora:
  image: $CI_REGISTRY/$BUILD_IMAGES_PROJECT:$FEDORA_BUILD
  script:
    - export CFLAGS=$CFLAGS_DEFAULT
    - ./bootstrap && touch .manywarnings
    - ./configure $CONFIGURE_BASE_FLAGS --enable-valgrind-tests
    - make -j$(nproc) check
  tags:
    - shared
  except:
    - tags
  artifacts:
    expire_in: 2 weeks
    when: on_failure
    paths:
      - ./*.log
      - fuzz/*.log
      - unit-tests/*.log
      - tests/*.log

VPATH build:
  image: $CI_REGISTRY/$BUILD_IMAGES_PROJECT:$DEBIAN_BUILD
  script:
    - export CFLAGS=$CFLAGS_DEFAULT
    - ./bootstrap
    - mkdir vpath && cd vpath
    - ../configure $CONFIGURE_BASE_FLAGS --cache-file ../cache/config.cache --disable-manywarnings
    - make -j$(nproc)
    - make -j$(nproc) distcheck
  artifacts:
    expire_in: 2 weeks
    when: on_failure
    paths:
      - ./*.log
      - fuzz/*.log
      - unit-tests/*.log
      - tests/*.log


#Centos7 build:
#  image: $CI_REGISTRY/$BUILD_IMAGES_PROJECT:$CENTOS7_BUILD
#  script:
#  - sed -i 's/AM_GNU_GETTEXT_VERSION(0.19.3)/AM_GNU_GETTEXT_VERSION(0.18.2)/g' configure.ac
#  - ./bootstrap && ./configure --enable-gcc-warnings --disable-doc && make -j$(nproc) check
#  tags:
#  - shared
#  artifacts:
#    expire_in: 2 weeks
#    when: on_failure
#    paths:
#      - tests/*.log
#      - compat_reports/

pages:
  image: $CI_REGISTRY/$BUILD_IMAGES_PROJECT:$DEBIAN_BUILD
  script:
    - ./bootstrap
    - export CFLAGS=$CFLAGS_DEFAULT
    - ./configure $CONFIGURE_BASE_FLAGS
    - make -j$(nproc) check-coverage
    - mkdir -p public
    # Test suite coverage report
    - rm -rf public/coverage
    - mv lcov public/coverage
    # Online Documentation
    - rm -rf public/reference
    - mv docs/html public/reference
    # Coverage report for all our fuzz corpora
    - make -j$(nproc) fuzz-coverage
    - rm -rf public/fuzz-coverage
    - mv lcov public/fuzz-coverage
  tags:
    - shared
  artifacts:
    when: on_success
    paths:
      - public
  only:
    - master

MinGW64:
  image: $CI_REGISTRY/$BUILD_IMAGES_PROJECT:$MINGW_BUILD
  script:
  - ./bootstrap
  - cp pthread_sigmask.c.mingw lib/pthread_sigmask.c
  - export CC="ccache $PREFIX-gcc"
  - export GCCLIB=$(dirname $(find /usr/lib/gcc/$PREFIX -name libgcc_s_seh-1.dll|grep posix))
  - export WINEPATH="$WINEPATH;/usr/$PREFIX/bin;/usr/$PREFIX/lib;$PWD/libwget/.libs;$GCCLIB"
  - echo "WINEPATH=$WINEPATH"
  - ./configure $CONFIGURE_BASE_FLAGS --build=x86_64-pc-linux-gnu --host=$PREFIX --enable-shared
  - make -j$(nproc)
  - make clean
  - ./configure $CONFIGURE_BASE_FLAGS --build=x86_64-pc-linux-gnu --host=$PREFIX --enable-shared --disable-threads
  - make -j$(nproc)
  - make check -j$(nproc) LOG_COMPILER=wine
  tags:
  - shared
  - docker
  except:
  - tags
  artifacts:
    expire_in: 2 weeks
    when: on_failure
    paths:
      - ./*.log
      - fuzz/*.log
      - unit-tests/*.log
      - tests/*.log
